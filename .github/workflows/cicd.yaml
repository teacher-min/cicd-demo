name: CI with Gradle

# 언제 실행될지 정의 (main 브랜치에 푸시될 때)
on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'k8s/**'  # k8s 폴더 변경 때문에 무한 루프 도는 것 방지

permissions:
  contents: write  # 리포지토리(YAML 파일)를 수정할 권한 부여

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 소스 코드 가져오기
    - uses: actions/checkout@v3

    # 2. JDK 17 세팅
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Gradle 빌드 (테스트 제외하여 속도 향상)
    - name: Build with Gradle
      run: ./gradlew clean build -x test

    # 4. 도커 허브 로그인 (Secret으로 등록한 도커 허브 아이디와 비밀번호 사용)
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 5. 도커 이미지 빌드 및 푸시
    # 이미지 태그를 현재 시간(초) 또는 Commit Hash로 설정하여 유니크하게 만듭니다.
    - name: Build and Push Docker Image
      env:
        DOCKER_ID: ${{ secrets.DOCKER_USERNAME }}
        IMAGE_NAME: cicd-demo
      run: |
        # 짧은 커밋 해시(7자리)를 태그로 사용 (예: abc1234)
        IMAGE_TAG=${GITHUB_SHA::7}
        
        docker build -t $DOCKER_ID/$IMAGE_NAME:$IMAGE_TAG .
        docker push $DOCKER_ID/$IMAGE_NAME:$IMAGE_TAG
        
        # 다음 단계를 위해 태그를 환경변수로 저장
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    # 6. k8s 매니페스트 수정 (GitOps의 핵심!)
    # deployment.yaml 파일의 image: 부분을 방금 만든 태그로 교체합니다.
    - name: Update Kubernetes Manifest
      env:
        DOCKER_ID: ${{ secrets.DOCKER_USERNAME }}
        IMAGE_NAME: cicd-demo
      run: |
        cd k8s
        # deployment.yaml 파일에서 image 태그 부분을 찾아서 sed 명령어로 수정
        # (Linux sed 문법 사용)
        sed -i "s|image: .*|image: $DOCKER_ID/$IMAGE_NAME:${{ env.IMAGE_TAG }}|g" deployment.yaml
        
        # 수정된 내용 확인 (로그용)
        cat deployment.yaml

    # 7. 수정된 매니페스트를 GitHub에 다시 푸시
    - name: Commit and Push Manifest
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add k8s/deployment.yaml
        git commit -m "Update image tag to ${{ env.IMAGE_TAG }}"
        git push